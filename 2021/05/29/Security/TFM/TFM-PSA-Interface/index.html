

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/world.png">
  <link rel="icon" href="/img/world.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#3e424a">
  <meta name="author" content="Jianliang·Shen">
  <meta name="keywords" content="">
  
    <meta name="description" content="PSA InterfacePSA接口完成从NS的client到secure服务的调用。">
<meta property="og:type" content="article">
<meta property="og:title" content="TF-M PSA Interface">
<meta property="og:url" content="http://yoursite.com/2021/05/29/Security/TFM/TFM-PSA-Interface/index.html">
<meta property="og:site_name" content="TechOdyssey">
<meta property="og:description" content="PSA InterfacePSA接口完成从NS的client到secure服务的调用。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/img/post_pics/TF-M/tfm_if.png">
<meta property="article:published_time" content="2021-05-29T11:48:09.000Z">
<meta property="article:modified_time" content="2024-07-30T16:39:00.419Z">
<meta property="article:author" content="Jianliang·Shen">
<meta property="article:tag" content="TF-M">
<meta property="article:tag" content="TEE">
<meta property="article:tag" content="Security">
<meta property="article:tag" content="Arm">
<meta property="article:tag" content="Firmware">
<meta property="article:tag" content="PSA">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://yoursite.com/img/post_pics/TF-M/tfm_if.png">
  
  
  
  <title>TF-M PSA Interface - TechOdyssey</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/icon.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":15,"cursorChar":"|","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":"❡"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Tech Odyssey</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-bookmark-fill"></i>
                <span>Favor</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="https://vercel.com/jianliang-shens-projects" target="_self">
                    <i class="iconfont icon-vercel"></i>
                    <span>Vercel</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/pdf/" target="_self">
                    <i class="iconfont icon-pdf-new"></i>
                    <span>PDF</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://www.google.com/" target="_self">
                    <i class="iconfont icon-google-new"></i>
                    <span>Google</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://www.baidu.com/" target="_self">
                    <i class="iconfont icon-baidu-new"></i>
                    <span>Baidu</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://github.com/Jianliang-Shen" target="_self">
                    <i class="iconfont icon-github-new"></i>
                    <span>Github</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://www.zhihu.com" target="_self">
                    <i class="iconfont icon-zhihu-new"></i>
                    <span>Zhihu</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://www.bilibili.com/" target="_self">
                    <i class="iconfont icon-bilibili-new"></i>
                    <span>Bilibili</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://chat.openai.com/" target="_self">
                    <i class="iconfont icon-chatGPT"></i>
                    <span>Chatgpt</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://msdn.itellyou.cn/" target="_self">
                    <i class="iconfont icon-microsoft"></i>
                    <span>MSDN</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://www.iconfont.cn/" target="_self">
                    <i class="iconfont icon-iconfont"></i>
                    <span>Ali Icon</span>
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/back_1.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.1)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="TF-M PSA Interface"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-05-29 11:48" pubdate>
          2021年5月29日 中午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          717 words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          6 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">TF-M PSA Interface</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="PSA-Interface"><a href="#PSA-Interface" class="headerlink" title="PSA Interface"></a>PSA Interface</h2><p>PSA接口完成从NS的client到secure服务的调用。</p>
<span id="more"></span> 

<details>
<summary>server.c</summary>  
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//in psa_client.c</span><br>__attribute__((naked))<br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">psa_framework_version</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    __ASM <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;SVC %0           \n&quot;</span></span><br><span class="hljs-params">                   <span class="hljs-string">&quot;BX LR            \n&quot;</span></span><br><span class="hljs-params">                   : : <span class="hljs-string">&quot;I&quot;</span> (TFM_SVC_PSA_FRAMEWORK_VERSION))</span>;<br>&#125;<br><br><span class="hljs-comment">//in tfm_core_svcalls_ipc.c</span><br><span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> <span class="hljs-title function_">SVC_Handler_IPC</span><span class="hljs-params">(<span class="hljs-type">tfm_svc_number_t</span> svc_num, <span class="hljs-type">uint32_t</span> *ctx,</span><br><span class="hljs-params">                               <span class="hljs-type">uint32_t</span> lr)</span><br>&#123;<br>    <span class="hljs-type">bool</span> ns_caller = <span class="hljs-literal">false</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partition_t</span> *<span class="hljs-title">partition</span> =</span> <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">uint32_t</span> veneer_base =<br>        (<span class="hljs-type">uint32_t</span>)&amp;REGION_NAME(Image$$, TFM_UNPRIV_CODE, $$RO$$Base);<br>    <span class="hljs-type">uint32_t</span> veneer_limit =<br>        (<span class="hljs-type">uint32_t</span>)&amp;REGION_NAME(Image$$, TFM_UNPRIV_CODE, $$RO$$Limit);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * The caller security attribute detection bases on LR of state context.</span><br><span class="hljs-comment">     * However, if SP calls PSA APIs based on its customized SVC, the LR may be</span><br><span class="hljs-comment">     * occupied by general purpose value while calling SVC.</span><br><span class="hljs-comment">     * Check if caller comes from non-secure: return address (ctx[6]) is belongs</span><br><span class="hljs-comment">     * to veneer section, and the bit0 of LR (ctx[5]) is zero.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">if</span> (ctx[<span class="hljs-number">6</span>] = veneer_base &amp;&amp; ctx[<span class="hljs-number">6</span>] &lt; veneer_limit &amp;&amp;<br>        !(ctx[<span class="hljs-number">5</span>] &amp; TFM_VENEER_LR_BIT0_MASK)) &#123;<br>        ns_caller = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    partition = tfm_spm_get_running_partition();<br>    <span class="hljs-keyword">if</span> (!partition) &#123;<br>        tfm_core_panic();<br>    &#125;<br><br>    tfm_spm_validate_caller(partition, ctx, lr, ns_caller);<br><br>    <span class="hljs-keyword">switch</span> (svc_num) &#123;<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_FRAMEWORK_VERSION:<br>        <span class="hljs-keyword">return</span> tfm_spm_psa_framework_version();<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_VERSION:<br>        <span class="hljs-keyword">return</span> tfm_spm_psa_version(ctx, ns_caller);<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_CONNECT:<br>        <span class="hljs-keyword">return</span> tfm_spm_psa_connect(ctx, ns_caller);<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_CALL:<br>        <span class="hljs-keyword">return</span> tfm_spm_psa_call(ctx, ns_caller, lr);<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_CLOSE:<br>        tfm_spm_psa_close(ctx, ns_caller);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_WAIT:<br>        <span class="hljs-keyword">return</span> tfm_spm_psa_wait(ctx);<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_GET:<br>        <span class="hljs-keyword">return</span> tfm_spm_psa_get(ctx);<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_SET_RHANDLE:<br>        tfm_spm_psa_set_rhandle(ctx);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_READ:<br>        <span class="hljs-keyword">return</span> tfm_spm_psa_read(ctx);<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_SKIP:<br>        <span class="hljs-keyword">return</span> tfm_spm_psa_skip(ctx);<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_WRITE:<br>        tfm_spm_psa_write(ctx);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_REPLY:<br>        tfm_spm_psa_reply(ctx);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_NOTIFY:<br>        tfm_spm_psa_notify(ctx);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_CLEAR:<br>        tfm_spm_psa_clear();<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_EOI:<br>        tfm_spm_psa_eoi(ctx);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_PANIC:<br>        tfm_spm_psa_panic();<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> TFM_SVC_SPM_REQUEST:<br>        tfm_spm_request_handler((<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-type">tfm_state_context_t</span> *)ctx);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_LIFECYCLE:<br>        <span class="hljs-keyword">return</span> tfm_spm_get_lifecycle_state();<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> (TFM_SPM_LOG_LEVEL TFM_SPM_LOG_LEVEL_SILENCE)</span><br>    <span class="hljs-keyword">case</span> TFM_SVC_OUTPUT_UNPRIV_STRING:<br>        <span class="hljs-keyword">return</span> tfm_hal_output_spm_log((<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)ctx[<span class="hljs-number">0</span>], ctx[<span class="hljs-number">1</span>]);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_IRQ_ENABLE:<br>        tfm_spm_irq_enable(ctx);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> TFM_SVC_PSA_IRQ_DISABLE:<br>        <span class="hljs-keyword">return</span> tfm_spm_irq_disable(ctx);<br>    <span class="hljs-keyword">default</span>:<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PLATFORM_SVC_HANDLERS</span><br>        <span class="hljs-keyword">return</span> (platform_svc_handlers(svc_num, ctx, lr));<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>        ERROR_MSG(<span class="hljs-string">&quot;Unknown SVC number requested!&quot;</span>);<br>        <span class="hljs-keyword">return</span> PSA_ERROR_GENERIC_ERROR;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>    <span class="hljs-keyword">return</span> PSA_SUCCESS;<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">tfm_core_svc_handler</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> *msp, <span class="hljs-type">uint32_t</span> *psp, <span class="hljs-type">uint32_t</span> exc_return)</span><br>&#123;<br>    <span class="hljs-type">tfm_svc_number_t</span> svc_number = TFM_SVC_PSA_FRAMEWORK_VERSION;<br>    <span class="hljs-type">uint32_t</span> *svc_args = msp;<br><br>    <span class="hljs-keyword">if</span> (!(exc_return &amp; EXC_RETURN_MODE)) &#123;<br>        <span class="hljs-comment">/* Calling SVC from Handler Mode is not supported */</span><br>        tfm_core_panic();<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((exc_return &amp; EXC_RETURN_MODE) &amp;&amp; (exc_return &amp; EXC_RETURN_SPSEL)) &#123;<br>        <span class="hljs-comment">/* Use PSP when both EXC_RETURN.MODE and EXC_RETURN.SPSEL are set */</span><br>        svc_args = psp;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        svc_args = msp;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Stack contains:</span><br><span class="hljs-comment">     * r0, r1, r2, r3, r12, r14 (lr), the return address and xPSR</span><br><span class="hljs-comment">     * First argument (r0) is svc_args[0]</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">if</span> (is_return_secure_stack(exc_return)) &#123;<br>        <span class="hljs-comment">/* SV called directly from secure context. Check instruction for</span><br><span class="hljs-comment">         * svc_number</span><br><span class="hljs-comment">         */</span><br>        svc_number = ((<span class="hljs-type">tfm_svc_number_t</span> *)svc_args[<span class="hljs-number">6</span>])[<span class="hljs-number">-2</span>];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">/* Secure SV executing with NS return.</span><br><span class="hljs-comment">         * NS cannot directly trigger S SVC so this should not happen. This is</span><br><span class="hljs-comment">         * an unrecoverable error.</span><br><span class="hljs-comment">         */</span><br>        tfm_core_panic();<br>    &#125;<br>    <span class="hljs-keyword">switch</span> (svc_number) &#123;<br>    <span class="hljs-keyword">case</span> TFM_SVC_HANDLER_MODE:<br>        tfm_arch_clear_fp_status();<br>        exc_return = tfm_spm_init();<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> TFM_SVC_GET_BOOT_DATA:<br>        tfm_core_get_boot_data_handler(svc_args);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        svc_args[<span class="hljs-number">0</span>] = SVC_Handler_IPC(svc_number, svc_args, exc_return);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> exc_return;<br>&#125;<br></code></pre></td></tr></table></figure>

</details> 

<p>代码中有一些重点：</p>
<ul>
<li><p><code>__attribute__((naked))</code></p>
<p>This attribute tells the compiler that the function is an embedded assembly function. You can write the body of the function entirely in assembly code using <code>__asm</code> statements.</p>
<p>The compiler does not generate prologue and epilogue sequences for functions with <code>__attribute__((naked))</code>.</p>
<p>The compiler only supports basic <code>__asm</code> statements in <code>__attribute__((naked))</code> functions. Using extended assembly, parameter references or mixing C code with <code>__asm</code> statements might not work reliably.</p>
</li>
<li><p><code>__ASM</code></p>
</li>
</ul>
<p>__asm 关键字用于调用内联汇编程序，并且可在 C 或 C++ 语句合法时出现</p>
<ul>
<li><code>volatile</code></li>
</ul>
<p><code>volatile</code> tells the compiler not to optimize anything that has to do with the <code>volatile</code> variable.</p>
<p>不只是内嵌汇编操纵栈”这种方式属于编译无法识别的变量改变，另外更多的可能是多线程并发访问共享变量时，一个线程改变了变量的值，怎样让改变后的值对其它线程 visible。一般说来，volatile用在如下的几个地方：</p>
<ul>
<li><p>中断服务程序中修改的供其它程序检测的变量需要加 volatile；</p>
</li>
<li><p>多任务环境下各任务间共享的标志应该加 volatile；</p>
</li>
<li><p>存储器映射的硬件寄存器通常也要加 volatile 说明，因为每次对它的读写都可能由不同意义；</p>
</li>
<li><p><code>SVC</code></p>
</li>
</ul>
<p>ARM有两种模式，handler处理器模式和thread线程模式，前者能够访问更多的资源并始终处于特权模式下，SVC实现thread模式向handler模式的请求，请求通过imm立即数跳转。参考：<a href="https://blog.csdn.net/guozhongwei1/article/details/49544671?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-3.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-3.control"> cortex-M3 的SVC、PendSV异常，与操作系统(ucos实时系统)_@角色扮演#-CSDN博客</a></p>
<p>In ARMv8-M document:<br><img src="/img/post_pics/TF-M/tfm_if.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Supervisor-calls"><a href="#Supervisor-calls" class="headerlink" title="Supervisor calls"></a>Supervisor calls</h2><p>看一下ARMV8-ARM中对SVC的解释：</p>
<p>The <code>SVC</code> instruction generates an SVC. A typical use for SVCs is to request privileged operations or access to system resources from an operating system.</p>
<p>The <code>SVC</code> instruction has a number embedded within it, often referred to as the SVC number. On most ARM processors, the SVC number indicates the service that is being requested. On microcontroller profiles, the processor saves the argument registers to the stack on the initial exception entry.</p>
<p>A late-arriving exception, taken before the first instruction of the SVC handler executes, might corrupt the copy of the arguments still held in R0 to R3. This means that the stack copy of the arguments must be used by the SVC handler. Any return value must also be passed back to the caller by modifying the stacked register values. In order to do this, a short piece of assembly code must be implemented at the start of the SVC handler. This identifies where the registers are saved, extracts the SVC number from the instruction, and passes the number, and a pointer to the arguments, to the main body of the handler written in C.</p>
<p>The following example shows an example SVC handler. This code tests the EXC_RETURN value set by the processor to determine which stack pointer was in use when the <code>SVC</code> was called. This can be useful for reentrant SVCs, but is unnecessary on most systems because in a typical system design, SVCs are only called from user code that uses the process stack. In such cases, the assembly code can consist of a single <code>MSR</code> instruction followed by a tail calling branch (<code>B</code> instruction) to the C body of the handler.</p>
<h2 id="Example-SVC-Handler"><a href="#Example-SVC-Handler" class="headerlink" title="Example SVC Handler"></a>Example SVC Handler</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c">__asm <span class="hljs-type">void</span> <span class="hljs-title function_">SVCHandler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    IMPORT SVCHandler_main<br>    TST lr, #<span class="hljs-number">4</span><br>    ITE EQ<br>    MRSEQ R0, MSP<br>    MRSNE R0, PSP<br>    B SVCHandler_main<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">SVCHandler_main</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> * svc_args)</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> svc_number;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    * Stack contains:</span><br><span class="hljs-comment">    * R0, R1, R2, R3, R12, R14, the return address and xPSR</span><br><span class="hljs-comment">    * First argument (R0) is svc_args[0]</span><br><span class="hljs-comment">    */</span><br>    svc_number = ((<span class="hljs-type">char</span> *)svc_args[<span class="hljs-number">6</span>])[<span class="hljs-number">-2</span>];<br>    <span class="hljs-keyword">switch</span>(svc_number)<br>    &#123;<br>        <span class="hljs-keyword">case</span> SVC_00:<br>            <span class="hljs-comment">/* Handle SVC 00 */</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SVC_01:<br>            <span class="hljs-comment">/* Handle SVC 01 */</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-comment">/* Unknown SVC */</span><br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>The following example shows how you can make different declarations for a number of SVCs. <code>__svc</code> is a compiler keyword that replaces a function call with an <code>SVC</code> instruction containing the specified number.</p>
<h2 id="Example-of-calling-an-SVC-from-C-code"><a href="#Example-of-calling-an-SVC-from-C-code" class="headerlink" title="Example of calling an SVC from C code"></a>Example of calling an SVC from C code</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SVC_00 0x00</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SVC_01 0x01</span><br><span class="hljs-type">void</span> __svc(SVC_00) svc_zero(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-built_in">string</span>);<br><span class="hljs-type">void</span> __svc(SVC_01) svc_one(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-built_in">string</span>);<br><span class="hljs-type">int</span> <span class="hljs-title function_">call_system_func</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    svc_zero(<span class="hljs-string">&quot;String to pass to SVC handler zero&quot;</span>);<br>    svc_one(<span class="hljs-string">&quot;String to pass to a different OS function&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Security/" class="category-chain-item">Security</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/TF-M/" class="print-no-link">#TF-M</a>
      
        <a href="/tags/TEE/" class="print-no-link">#TEE</a>
      
        <a href="/tags/Security/" class="print-no-link">#Security</a>
      
        <a href="/tags/Arm/" class="print-no-link">#Arm</a>
      
        <a href="/tags/Firmware/" class="print-no-link">#Firmware</a>
      
        <a href="/tags/PSA/" class="print-no-link">#PSA</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/05/29/Security/TFM/How-TFM-Call-Secure/" title="TF-M是如何调用secure接口的">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">TF-M是如何调用secure接口的</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/05/28/Security/TFM/Trusted-Firmware/" title="ARM Trusted Firmware">
                        <span class="hidden-mobile">ARM Trusted Firmware</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Tech Odyssey</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>2024</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
<!-- hexo injector body_end start --><script data-pjax src="https://unpkg.com/oh-my-live2d"></script><script>const oml2d = OML2D.loadOml2d({dockedPosition:"left",mobileDisplay:false,models:[{"path":"/live2d-models/models/umaru/model.json","position":[100,30],"scale":0.25,"stageStyle":{"width":400,"height":470}},{"path":"/live2d-models/models/kobayaxi/model.json","position":[30,0],"scale":0.3,"stageStyle":{"width":400}},{"path":"/live2d-models/models/bilibili-22/index.json","position":[0,30],"scale":0.35,"stageStyle":{"width":400}},{"path":"/live2d-models/models/bilibili-33/index.json","position":[0,30],"scale":0.35,"stageStyle":{"width":400}}],parentElement:document.body,primaryColor:"#7f6f6c",tips:{style: {"left":"calc(50%)","top":"-50px"},idleTips:{interval:150}}});</script><!-- hexo injector body_end end --></body>
</html>
